<script type="text/html" data-template-name="nhc2-config">
  <div class="form-row">
    <label>Auto Discover</label>
    <input type="checkbox" id="node-config-input-autodiscover">
  </div>
  <div class="form-row" id="mac-select-row" style="display:none;">
    <label>Select Controller (MAC)</label>
    <select id="node-config-input-mac" style="width:100%"></select>
  </div>
  <div class="form-row" id="host-row">
    <label>Host</label>
    <input id="node-config-input-host">
  </div>
  <div class="form-row">
    <label>Port</label>
    <input id="node-config-input-port">
  </div>
  <div class="form-row">
    <label>Username</label>
    <input id="node-config-input-username">
  </div>
  <div class="form-row">
    <label>Password</label>
    <input type="password" id="node-config-input-password">
  </div>
  <div class="form-row">
    <label>Debug</label>
    <input type="checkbox" id="node-config-input-debug">
  </div>
  <div class="form-row">
    <label>Watchdog</label>
    <input type="checkbox" id="node-config-input-watchdog">
  </div>  
  <div class="form-row">
    <button id="node-config-refresh">Refresh Devices</button>
  </div>
</script>

<script>
RED.nodes.registerType('nhc2-config', {
  category: 'config',
  defaults: {
    host:       { value: '' },
    port:       { value: 8884 },
    username:   { value: '' },
    password:   { value: '' },
    autodiscover: { value: false },
    mac:        { value: '' },
    debug:      { value: false },
    watchdog:   { value: false }
  },
  label: function() {
    return this.autodiscover
      ? `Auto (${this.mac})`
      : `${this.host}:${this.port}`;
  },
  oneditprepare: function() {
    const rawRoot = RED.settings.httpAdminRoot;
    const p = window.location.pathname;
    const fallbackRoot = p.substring(0, p.lastIndexOf('/'));
    let adminRoot = '';
    if (rawRoot && rawRoot !== '/') {
      adminRoot = rawRoot.endsWith('/') ? rawRoot : rawRoot + '/';
    } else {
      adminRoot = fallbackRoot;
    }
    const macRow = $('#mac-select-row'),
          hostRow = $('#host-row');

    $('#node-config-input-autodiscover')
      .prop('checked', this.autodiscover)
      .change(function() {
        if ($(this).is(':checked')) {
          macRow.show(); hostRow.hide();
          $.getJSON(`${adminRoot}/nhc2-config/discover`)
            .done(ctrls => {
              const sel = $('#node-config-input-mac').empty();
              ctrls.forEach(c => {
                $('<option>')
                  .val(c.mac)
                  .text(`${c.mac} | Serial: ${c.serial} | IP: ${c.ip}`)
                  .appendTo(sel);
              });
            });
        } else {
          macRow.hide(); hostRow.show();
        }
      })
      .change();

    $('#node-config-refresh').on('click', () => {
      $.post(`${adminRoot}/nhc2-config/${this.id}/refresh`)
        .done(() => RED.notify('Refresh sent','success'))
        .fail(() => RED.notify('Refresh failed','error'));
    });
  }
});
</script>
