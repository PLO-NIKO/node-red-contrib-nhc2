<script type="text/html" data-template-name="nhc2-config">
  <style>
    .form-row { display: flex; flex-direction: column; margin-bottom: 10px; }
    .form-row label { font-weight: bold; margin-bottom: 4px; }
    .help-block { margin-top: 2px; font-size: 0.875em; color: #666; }
    .form-actions { text-align: right; margin-top: 15px; }
  </style>

  <div class="form-row">
    <label for="node-config-input-autodiscover"><i class="fa fa-plug"></i> Auto Discover</label>
    <input type="checkbox" id="node-config-input-autodiscover" />
    <div class="help-block">Automatically scan your network to find compatible controllers.</div>
  </div>

  <div class="form-row" id="mac-select-row" style="display:none;">
    <label for="node-config-input-mac"><i class="fa fa-hashtag"></i> Select Controller (MAC)</label>
    <select id="node-config-input-mac" style="width:100%"></select>
    <div class="help-block">Choose a discovered controller by its MAC address.</div>
  </div>

  <div class="form-row" id="host-row">
    <label for="node-config-input-host"><i class="fa fa-server"></i> Host</label>
    <input type="text" id="node-config-input-host" placeholder="e.g. 192.168.1.10" />
    <div class="help-block">IP address or hostname of the controller (used if Auto Discover is disabled).</div>
  </div>

  <div class="form-row" id="port-row">
    <label for="node-config-input-port"><i class="fa fa-plug"></i> Port</label>
    <input type="number" id="node-config-input-port" placeholder="e.g. 8884" value="8884" />
    <div class="help-block">Port number on which the controller listens for connections. Defaults to 8884 when username is "hobby".</div>
  </div>

  <div class="form-row" id="username-row">
    <label for="node-config-input-username"><i class="fa fa-user"></i> Username</label>
    <input type="text" id="node-config-input-username" value="hobby" />
    <div class="help-block">Username for authenticating with the controller’s API. Often "hobby" for standard setups.</div>
  </div>

  <div class="form-row" id="password-row">
    <label for="node-config-input-password"><i class="fa fa-key"></i> Password</label>
    <input type="password" id="node-config-input-password" />
    <div class="help-block">Password for authenticating with the controller’s API.</div>
  </div>

  <div class="form-row">
    <label for="node-config-input-debug"><i class="fa fa-bug"></i> Debug</label>
    <input type="checkbox" id="node-config-input-debug" />
    <div class="help-block">Enable verbose logging to help troubleshoot communication issues.</div>
  </div>

  <div class="form-row">
    <label for="node-config-input-watchdog"><i class="fa fa-shield"></i> Watchdog</label>
    <input type="checkbox" id="node-config-input-watchdog" />
    <div class="help-block">Automatically reconnect if no ping is received from the controller within 30 seconds. Recommended when Auto Discover is enabled.</div>
  </div>

  <div class="form-actions">
    <button type="button" id="node-config-refresh" class="primary">Refresh Devices</button>
    <div class="help-block" style="display:inline-block; margin-left:10px;">Manually reload the list of devices from the controller.</div>
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType('nhc2-config',{
    category: 'config',
    defaults: {
        name:         {value:""},
        autodiscover: {value:false},
        mac:          {value:""},
        host:         {value:""},
        port:         {value:""},
        username:     {value:""},
        password:     {value:""},
        debug:        {value:false},
        watchdog:     {value:false},
    },
    label: function() {
        return this.name || "nhc2-config";
    },
    oneditprepare: function() {
        var node        = this;
        var autodisc    = $("#node-config-input-autodiscover");
        var macRow      = $("#mac-select-row");
        var macSelect   = $("#node-config-input-mac");
        var hostRow     = $("#host-row");
        var portRow     = $("#port-row");
        var usernameRow = $("#username-row");
        var passwordRow = $("#password-row");
        var hostInput   = $("#node-config-input-host");
        var portInput   = $("#node-config-input-port");
        var userInput   = $("#node-config-input-username");
        var passInput   = $("#node-config-input-password");
        var debugCheck  = $("#node-config-input-debug");
        var wdCheck     = $("#node-config-input-watchdog");
        var refreshBtn  = $("#node-config-refresh");

        // normalize adminRoot
        var rawRoot  = RED.settings.httpAdminRoot;
        var p        = window.location.pathname;
        var fallback = p.substring(0, p.lastIndexOf('/')) + '/';
        var adminRoot = (rawRoot && rawRoot !== '/')
            ? (rawRoot.charAt(rawRoot.length-1) === '/' ? rawRoot : rawRoot + '/')
            : fallback;

        // initialize fields from saved node
        autodisc.prop('checked', node.autodiscover);
        macSelect.val(node.mac);
        hostInput.val(node.host);
        portInput.val(node.port);
        userInput.val(node.username);
        passInput.val(node.password);
        debugCheck.prop('checked', node.debug);
        wdCheck.prop('checked', node.watchdog);

        // show/hide host/port/user/pass when Use Secrets
        function toggleSecrets() {
          // host depends on autodiscover
          if (autodisc.is(':checked')) {
              hostRow.hide();
          } else {
              hostRow.show();
          }
          portRow.show();
          usernameRow.show();
          passwordRow.show();
            
        }

        // show/hide host vs mac when autodiscover
        function toggleAutodiscover() {
            if (autodisc.is(':checked')) {
                macRow.show();
                hostRow.hide();
            } else {
                macRow.hide();
                hostRow.show();
            }
        }

        // fetch MAC list
        function loadControllers() {
            $.getJSON(adminRoot + 'nhc2-config/discover')
             .done(function(ctrls) {
                 macSelect.empty();
                 ctrls.forEach(function(c) {
                     $('<option>')
                       .val(c.mac)
                       .text(c.mac + ' | Serial: ' + c.serial + ' | IP: ' + c.ip)
                       .appendTo(macSelect);
                 });
                 if (node.mac) {
                     macSelect.val(node.mac);
                 }
             })
             .fail(function() {
                 RED.notify('Failed to load controllers', 'error');
             });
        }

        // Auto Discover toggled
        autodisc.change(function() {
            toggleAutodiscover();
            toggleSecrets();
            if ($(this).is(':checked')) {
                loadControllers();
            }
        });

        // Refresh Devices
        refreshBtn.click(function() {
            $.post(adminRoot + 'nhc2-config/' + node.id + '/refresh')
             .done(function() { RED.notify('Refresh sent','success'); })
             .fail(function() { RED.notify('Refresh failed','error'); });
        });

        // initial
        toggleAutodiscover();
        toggleSecrets();
        if (node.autodiscover) {
            loadControllers();
        }
    }
});
</script>
