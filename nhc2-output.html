<script type="text/html" data-template-name="nhc2-output">
  <div class="form-row">
    <label>Config</label>
    <select id="node-input-config"></select>
  </div>
  <div class="form-row">
    <label>Search</label>
    <input type="text"
           id="node-input-deviceFilter"
           placeholder="Type to filter devices…"
           style="width:100%">
  </div>
  <div class="form-row">
    <label>Device</label>
    <select id="node-input-deviceUuid"></select>
  </div>
  <input type="hidden" id="node-input-deviceName">
  <div class="form-row">
    <label>Property</label>
    <select id="node-input-property"></select>
  </div>
  <div class="form-row">
    <label>Definitions</label>
    <table id="node-input-propertyTable"
           style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left">Property</th>
          <th style="text-align:left">HasStatus</th>
          <th style="text-align:left">CanControl</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</script>

<script>
RED.nodes.registerType('nhc2-output',{
  category: 'NHC2',
  defaults: {
    config:      { type:'nhc2-config', required:true },
    deviceUuid:  { value:'', required:true },
    deviceName:  { value:'' },    // ← new hidden field
    property:    { value:'' }
  },
  inputs: 1, outputs: 0,
  icon: 'bridge.svg',
  // dynamic label reads the stored deviceName + property (or falls back)
  label: function() {
    const name = this.deviceName || 'NHC2 Out';
    const prop = this.property  || 'All';
    return `${name} [${prop}]`;
  },
  oneditprepare: function(){
    // normalize adminRoot
    const rawRoot = RED.settings.httpAdminRoot;
    const p = window.location.pathname;
    const fallbackDir  = p.substring(0, p.lastIndexOf('/'));
    const fallbackRoot = fallbackDir + '/';
    let adminRoot = '';
    if (rawRoot && rawRoot !== '/') {
      adminRoot = rawRoot.endsWith('/') ? rawRoot : rawRoot + '/';
    } else {
      adminRoot = fallbackRoot;
    }

    const me = this;
    let devices = [];

    function formatLabel(d){
      const loc = (d.Parameters.find(p=>p.LocationName)||{}).LocationName || '';
      return `${d.Name} (${d.Model} – ${d.Type} – ${loc})`;
    }

    function filterAndRender(){
      const filter = $('#node-input-deviceFilter').val().toLowerCase();
      const select = $('#node-input-deviceUuid').empty();
      devices
        .filter(d=> formatLabel(d).toLowerCase().includes(filter) )
        .forEach(d=>{
          $('<option>')
            .val(d.Uuid)
            .text(formatLabel(d))
            .appendTo(select);
        });
      if (me.deviceUuid){
        select.val(me.deviceUuid);
      }
      $('#node-input-deviceName').val(
        (devices.find(d=>d.Uuid===select.val())||{}).Name || ''
      );
      select.trigger('change');
    }

    function populateDevices(){
      const cid = $('#node-input-config').val();
      if (!cid) { return; }
      $.getJSON(adminRoot + 'nhc2-config/' + cid + '/devices')
        .done(devsObj=>{
          devices = Object.values(devsObj);
          const cfg = RED.nodes.node(me.config);
          if (cfg) { cfg.devices = devices; }
          filterAndRender();
        });
    }

      function populateProperties(){
      const uuid = $('#node-input-deviceUuid').val();
      me.deviceUuid = uuid;
      const dev = devices.find(d=>d.Uuid===uuid);
      if (!dev) { return; }

      const defs = dev.PropertyDefinitions || [];
      const propSel = $('#node-input-property').empty();

      // ← Add the “All” entry first
      $('<option>')
        .val('')
        .text('All')
        .appendTo(propSel);

      // Then list each real property
      defs.forEach(o=>{
        const name = Object.keys(o)[0];
        $('<option>')
          .val(name)
          .text(name)
          .appendTo(propSel);
      });

      // Restore last saved or default to “All”
      propSel.val(me.property || '');

      const tb = $('#node-input-propertyTable tbody').empty();
      defs.forEach(o=>{
        const name = Object.keys(o)[0];
        const def  = o[name];
        $('<tr>')
          .append($('<td>').text(name))
          .append($('<td>').text(def.HasStatus))
          .append($('<td>').text(def.CanControl))
          .appendTo(tb);
      });
    }

    // event wiring
    $('#node-input-config').on('change', populateDevices);
    $('#node-input-deviceFilter').on('input', filterAndRender);
    $('#node-input-deviceUuid').on('change', ()=>{
      $('#node-input-deviceName').val(
        (devices.find(d=>d.Uuid===$('#node-input-deviceUuid').val())||{}).Name || ''
      );
      populateProperties();
    });
    $('#node-input-property').on('change', ()=>{
      me.property = $('#node-input-property').val();
    });

    // initialization
    $('#node-input-config').val(this.config);
    me.deviceUuid = this.deviceUuid;
    me.property   = this.property;
    $('#node-input-deviceFilter').val('');
    populateDevices();
  }
});
</script>
