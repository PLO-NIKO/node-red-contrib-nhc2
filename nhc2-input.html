<script type="text/html" data-template-name="nhc2-input">
  <div class="form-row"><label>Config</label><select id="node-input-config"></select></div>
  <div class="form-row"><label>Model</label><select id="node-input-model"><option value="">All</option></select></div>
  <div class="form-row"><label>Location</label><select id="node-input-location"><option value="">All</option></select></div>
  <div class="form-row"><label>Device</label><select id="node-input-deviceUuid"><option value="">-- Not Selected --</option></select></div>
  <div class="form-row"><label>Property</label><select id="node-input-property"><option value="">All</option></select></div>
  <div class="form-row" id="prop-table"><table style="width:100%"><tr><th>Property</th><th>Definition</th></tr></table></div>
</script>
<script>
RED.nodes.registerType('nhc2-input',{category:'input',defaults:{config:{type:'nhc2-config',required:true},deviceUuid:{value:''},propertyName:{value:''}},inputs:0,outputs:1,icon:'bridge.svg',label:function(){return'NHC2 In';},oneditprepare:function(){
  const me=this;
  function loadFilters(){
    const cid=$('#node-input-config').val(); if(!cid) return;
    $.getJSON(`/nhc2-config/${cid}/devices`).done(devs=>{
      const models=Array.from(new Set(Object.values(devs).map(d=>d.Model))).sort();
      const locs=Array.from(new Set(Object.values(devs).map(d=>d.Parameters.find(p=>p.LocationName)?.LocationName).filter(x=>x))).sort();
      $('#node-input-model').empty().append('<option value="">All</option>').append(models.map(m=>`<option value="${m}">${m}</option>`));
      $('#node-input-location').empty().append('<option value="">All</option>').append(locs.map(l=>`<option value="${l}">${l}</option>`));
      populateDevices();
    });
  }
  function populateDevices(){
    const cid=$('#node-input-config').val(),m=$('#node-input-model').val(),loc=$('#node-input-location').val(); if(!cid) return;
    $.getJSON(`/nhc2-config/${cid}/devices`).done(devs=>{
      const filtered=Object.values(devs).filter(d=>(!m||d.Model===m)&&(!loc||d.Parameters.find(p=>p.LocationName===loc)));
      filtered.sort((a,b)=>a.Name.localeCompare(b.Name));
      const sel=$('#node-input-deviceUuid').empty().append('<option value="">-- Not Selected --</option>');
      filtered.forEach(d=>sel.append(`<option value="${d.Uuid}">${d.Name} (${d.Model} - ${d.Type})</option>`));
      sel.val(me.deviceUuid).change();
    });
  }
  function filterFromDevice(){
    const cid=$('#node-input-config').val(),uid=$('#node-input-deviceUuid').val(); if(!cid||!uid) return;
    $.getJSON(`/nhc2-config/${cid}/devices`).done(devs=>{
      const d=devs[uid];
      if(d){
        $('#node-input-model').val(d.Model);
        const loc=d.Parameters.find(p=>p.LocationName)?.LocationName;
        if(loc) $('#node-input-location').val(loc);
        populateDevices();
      }
    });
  }
  function updateProps(){
    const cid=$('#node-input-config').val(),uid=$('#node-input-deviceUuid').val(); if(!cid||!uid) return;
    $.getJSON(`/nhc2-config/${cid}/devices`).done(devs=>{
      const d=devs[uid]||{},defs=d.PropertyDefinitions||[];
      const props=defs.map(pd=>{const k=Object.keys(pd)[0];return{k,def:pd[k]};}).sort((a,b)=>a.k.localeCompare(b.k));
      $('#node-input-property').html('<option value="">All</option>'+props.map(p=>`<option value="${p.k}">${p.k}</option>`));
      const rows=props.map(p=>`<tr><td>${p.k}</td><td>${JSON.stringify(p.def)}</td></tr>`).join('');
      $('#prop-table table').html('<tr><th>Property</th><th>Definition</th></tr>'+rows);
    });
  }
  $('#node-input-config').on('change',loadFilters);
  $('#node-input-model,#node-input-location').on('change',populateDevices);
  $('#node-input-deviceUuid').on('change',()=>{filterFromDevice(); updateProps();});
  $('#node-input-property').on('change',()=>me.propertyName=$('#node-input-property').val());
  loadFilters();
}});
</script>
