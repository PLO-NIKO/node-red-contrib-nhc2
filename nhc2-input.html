<script type="text/html" data-template-name="nhc2-input">
  <div class="form-row"><label>Config</label><select id="node-input-config"></select></div>
  <div class="form-row"><label>Device</label><select id="node-input-deviceUuid"></select></div>
</script>
<script>
RED.nodes.registerType('nhc2-input',{category:'input',defaults:{config:{type:'nhc2-config',required:true},deviceUuid:{value:''}},inputs:0,outputs:1,icon:'bridge.svg',
  label:function(){return 'NHC2 In';},
  oneditprepare:function(){
    const me = this;
    function populateDevices(){
      const cid = $('#node-input-config').val();
      if(!cid) return;
      $.getJSON(`/nhc2-config/${cid}/devices`).done(devs=>{
        const sel = $('#node-input-deviceUuid').empty();
        Object.values(devs).forEach(d => $('<option>').val(d.Uuid).text(d.Name).appendTo(sel));
        sel.val(me.deviceUuid);
      });
    }
    // Node-RED auto-populates config select
    $('#node-input-config').on('change', populateDevices);
    // Initial populate using current config
    $('#node-input-config').val(this.config);
    populateDevices();
  }
});
</script>